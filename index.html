<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trilateral Like Chart</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        :root {
            /* Financial palette */
            --c-asset-cur: #2E7D32;           /* green 800 */
            --c-asset-nc: #66BB6A;            /* green 400 */
            --c-asset-total: #1B5E20;         /* green 900 */

            --c-liab-cur: #EF6C00;            /* orange 800 */
            --c-liab-nc: #FB8C00;             /* orange 600 */
            --c-liab-int-cur: #C62828;        /* red 800 */
            --c-liab-int-nc: #E53935;         /* red 600 */
            --c-liab-int-total: #B71C1C;      /* red 900 */

            --c-equity-net: #1565C0;          /* blue 700 */
            --c-equity-re: #7E57C2;           /* purple 500 */

            --c-income-sales: #00838F;        /* teal 700 */
            --c-income-gp: #F9A825;           /* amber 700 */
            --c-income-oi: #3949AB;           /* indigo 600 */
            --c-income-ni: #2E7D32;           /* green 800 */

            --c-connection: #888888;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .input-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group h3 {
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
        }
        .input-row {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
        }
        .input-column {
            flex: 1;
        }
        .input-column h4 {
            margin-bottom: 10px;
            color: #555;
        }
        .input-field {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .input-field label {
            flex: 1;
            font-size: 14px;
            color: #666;
        }
        .input-field input {
            width: 150px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            text-align: right;
            /* room for color accent */
            border-left: 6px solid transparent;
            padding-left: 10px;
        }
        .input-field input[readonly] {
            background-color: #e9e9e9;
            font-weight: bold;
        }
        .company-info {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .company-info input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        #chart {
            display: flex;
            justify-content: center;
        }
        .title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
        }
        .subtitle {
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
            color: #666;
        }
        .rect-label {
            font-size: 14px;
            fill: black;
        }
        .rect-value {
            font-size: 13px;
            fill: black;
        }
        .rect-percentage {
            font-size: 13px;
            fill: black;
        }
        .dashed-rect {
            fill: none;
            stroke: var(--c-liab-int-total);
            stroke-width: 1.5;
            stroke-dasharray: 5,3;
        }
        .net-sales-label {
            font-size: 14px;
            font-weight: normal;
        }
        .net-income-label {
            font-size: 13px;
            font-weight: normal;
        }
        .update-button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .update-button:hover {
            background-color: #45a049;
        }

        .save-button {
            background-color: #1976D2;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .save-button:hover { background-color: #1565C0; }

        /* Disclaimer/notice style */
        .disclaimer {
            margin: 10px 0 20px;
            padding: 12px 14px;
            background: #FFF8E1;           /* light amber */
            border-left: 5px solid #F9A825; /* amber accent */
            border: 1px solid #FFECB3;
            border-radius: 4px;
            color: #5D4037;                /* brownish text */
            font-size: 14px;
            line-height: 1.6;
        }
        .disclaimer a { color: #1565C0; text-decoration: underline; }

    /* Color-accent each input field to match the chart */
    #currentAssets { border-left-color: var(--c-asset-cur); }
    #nonCurrentAssets { border-left-color: var(--c-asset-nc); }
    #totalAssets { border-left-color: var(--c-asset-total); }

    #currentLiabilities { border-left-color: var(--c-liab-cur); }
    #currentInterestBearingLiabilities { border-left-color: var(--c-liab-int-cur); }
    #nonCurrentLiabilities { border-left-color: var(--c-liab-nc); }
    #nonCurrentInterestBearingLiabilities { border-left-color: var(--c-liab-int-nc); }
    #interestBearingLiabilities { border-left-color: var(--c-liab-int-total); }

    #netAssets { border-left-color: var(--c-equity-net); }
    #retainedEarnings { border-left-color: var(--c-equity-re); }

    #netSales { border-left-color: var(--c-income-sales); }
    #grossProfit { border-left-color: var(--c-income-gp); }
    #operatingIncome { border-left-color: var(--c-income-oi); }
    #netIncome { border-left-color: var(--c-income-ni); }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; color: #333;">財務3表チャート作成ツール</h1>
        <div class="disclaimer">
            このツールは、國貞克則さんの<a href="https://amzn.asia/d/dYFHZZO">新版　財務3表一体理解法</a>　及び　<a href="https://amzn.asia/d/gYzzkBS">新版　財務3表一体理解法 (朝日新書)</a>　を読んで感銘を受けたいちファンが個人の興味で作ったものです。きちんと財務3表図解分析法に準拠した作図をするには、<a href="http://www.migiude.com/index.html">国貞さんの公式HP</a>でも紹介されている<a href="https://mielac.blogspot.com/p/index.html">ソフト「財務がみえ〜る」</a>をお使いください。
        </div>


        <div class="input-section">
            <div class="company-info">
                <div style="flex: 1;">
                    <label>会社名 (Company Name):</label>
                    <input type="text" id="companyName" value="General Motors" style="width: 100%;">
                </div>
                <div>
                    <label>期間 (Period):</label>
                    <input type="text" id="periodLabel" value="2011">
                </div>
                <div>
                    <label>単位 (Currency):</label>
                    <input type="text" id="currency" value="Millions USD">
                </div>
            </div>

            <div class="input-group">
                <h3>Balance Sheet (貸借対照表)</h3>
                <div class="input-row">
                    <div class="input-column">
                        <h4>資産の部 (Assets)</h4>
                        <div class="input-field">
                            <label>Current Assets (流動資産):</label>
                            <input type="number" id="currentAssets" value="64923">
                        </div>
                        <div class="input-field">
                            <label>Non-current Assets (固定資産):</label>
                            <input type="number" id="nonCurrentAssets" value="79680">
                        </div>
                        <div class="input-field">
                            <label><strong>Total Assets (総資産):</strong></label>
                            <input type="number" id="totalAssets" value="144603" readonly>
                        </div>
                    </div>
                    
                    <div class="input-column">
                        <h4>負債の部 (Liabilities)</h4>
                        <div class="input-field">
                            <label>Current Liabilities (流動負債):</label>
                            <input type="number" id="currentLiabilities" value="53226">
                        </div>
                        <div class="input-field">
                            <label>Current Interest-bearing Liabilities (流動有利子負債):</label>
                            <input type="number" id="currentInterestBearingLiabilities" value="3833">
                        </div>
                        <div class="input-field">
                            <label>Non-current Liabilities (固定負債):</label>
                            <input type="number" id="nonCurrentLiabilities" value="52386">
                        </div>
                        <div class="input-field">
                            <label>Non-current Interest-bearing Liabilities (固定有利子負債):</label>
                            <input type="number" id="nonCurrentInterestBearingLiabilities" value="10000">
                        </div>
                        <div class="input-field">
                            <label>Interest-bearing Liabilities (有利子負債):</label>
                            <input type="number" id="interestBearingLiabilities" value="13833" readonly>
                        </div>

                        <h4>純資産の部 (Equity)</h4>
                        <div class="input-field">
                            <label>Net Assets (純資産):</label>
                            <input type="number" id="netAssets" value="38991">
                        </div>
                        <div class="input-field">
                            <label>Retained Earnings (利益剰余金):</label>
                            <input type="number" id="retainedEarnings" value="7183">
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <h3>Income Statement (損益計算書)</h3>
                <div class="input-row">
                    <div class="input-column">
                        <div class="input-field">
                            <label>Net Sales (売上高):</label>
                            <input type="number" id="netSales" value="150276">
                        </div>
                    </div>
                    <div class="input-column">
                        <div class="input-field">
                            <label>Gross Profit (売上総利益・粗利):</label>
                            <input type="number" id="grossProfit" value="0">
                        </div>
                    </div>
                    <div class="input-column">
                        <div class="input-field">
                            <label>Operating Income (営業利益):</label>
                            <input type="number" id="operatingIncome" value="5656">
                        </div>
                    </div>
                    <div class="input-column">
                        <div class="input-field">
                            <label>Net Income (当期純利益):</label>
                            <input type="number" id="netIncome" value="9287">
                        </div>
                    </div>
                </div>
            </div>

            <button class="update-button" id="updateButton">チャートを更新 (Update Chart)</button>
            <button class="save-button" id="saveSvgButton">SVGで保存 (Save as SVG)</button>
        </div>

        <div class="title" id="chartTitle">General Motors 2011</div>
        <div class="subtitle" id="chartSubtitle">(Millions USD)</div>
        <div id="chart"></div>
    </div>

    <script>
        // Color palette used for inputs and chart
        const palette = {
            assets: {
                current: '#2E7D32',
                non_current: '#66BB6A',
                total: '#1B5E20',
            },
            liabilities: {
                current: '#EF6C00',
                non_current: '#FB8C00',
                interest_current: '#C62828',
                interest_non_current: '#E53935',
                interest_total: '#B71C1C',
            },
            equity: {
                net_assets: '#1565C0',
                retained_earnings: '#7E57C2',
            },
            income: {
                net_sales: '#00838F',
                gross_profit: '#F9A825',
                operating_income: '#3949AB',
                net_income: '#2E7D32',
                cost_of_sales: '#90A4AE',
            },
            neutral: {
                connection: '#888888'
            }
        };
        // Function to get data from input fields
        function getInputData() {
            return {
                company_name: document.getElementById('companyName').value,
                period_label: document.getElementById('periodLabel').value,
                currency: document.getElementById('currency').value,
                total_assets: parseFloat(document.getElementById('totalAssets').value) || 0,
                current_assets: parseFloat(document.getElementById('currentAssets').value) || 0,
                current_liabilities: parseFloat(document.getElementById('currentLiabilities').value) || 0,
                current_interest_bearing_liabilities: parseFloat(document.getElementById('currentInterestBearingLiabilities').value) || 0,
                interest_bearing_liabilities: parseFloat(document.getElementById('interestBearingLiabilities').value) || 0,
                non_current_assets: parseFloat(document.getElementById('nonCurrentAssets').value) || 0,
                non_current_liabilities: parseFloat(document.getElementById('nonCurrentLiabilities').value) || 0,
                non_current_interest_bearing_liabilities: parseFloat(document.getElementById('nonCurrentInterestBearingLiabilities').value) || 0,
                net_assets: parseFloat(document.getElementById('netAssets').value) || 0,
                retained_earnings: parseFloat(document.getElementById('retainedEarnings').value) || 0,
                net_sales: parseFloat(document.getElementById('netSales').value) || 0,
                gross_profit: parseFloat(document.getElementById('grossProfit').value) || 0,
                operating_income: parseFloat(document.getElementById('operatingIncome').value) || 0,
                net_income: parseFloat(document.getElementById('netIncome').value) || 0
            };
        }

        // Function to draw the chart
        function drawChart(data) {
            // Clear existing chart
            d3.select("#chart").selectAll("*").remove();

            // Update title and subtitle
            document.getElementById('chartTitle').textContent = `${data.company_name} ${data.period_label}`;
            document.getElementById('chartSubtitle').textContent = `(${data.currency})`;

            // Calculate ratios
            const ratios = {
                current_assets_ratio: data.total_assets > 0 ? (data.current_assets / data.total_assets * 100).toFixed(1) : "0.0",
                non_current_assets_ratio: data.total_assets > 0 ? (data.non_current_assets / data.total_assets * 100).toFixed(1) : "0.0",
                current_liabilities_ratio: data.total_assets > 0 ? (data.current_liabilities / data.total_assets * 100).toFixed(1) : "0.0",
                non_current_liabilities_ratio: data.total_assets > 0 ? (data.non_current_liabilities / data.total_assets * 100).toFixed(1) : "0.0",
                interest_bearing_liabilities_ratio: data.total_assets > 0 ? (data.interest_bearing_liabilities / data.total_assets * 100).toFixed(1) : "0.0",
                net_assets_ratio: data.total_assets > 0 ? (data.net_assets / data.total_assets * 100).toFixed(1) : "0.0",
                retained_earnings_ratio: data.total_assets > 0 ? (data.retained_earnings / data.total_assets * 100).toFixed(1) : "0.0",
                operating_income_ratio: data.net_sales > 0 ? (data.operating_income / data.net_sales * 100).toFixed(1) : "0.0",
                net_income_ratio: data.net_sales > 0 ? (data.net_income / data.net_sales * 100).toFixed(1) : "0.0"
            };

            // Set up dimensions
            const width = 800;
            const height = 600;
            const margin = { top: 50, right: 50, bottom: 100, left: 80 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            // Create SVG
            const svg = d3.select("#chart")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Define scale based on max of total_assets and net_sales
            const maxValue = Math.max(data.total_assets, data.net_sales, 1);
            const yScale = d3.scaleLinear()
                .domain([0, 100])
                .range([chartHeight, 0]);

            // Add Y-axis (ticks only, no line)
            g.append("g")
                .call(d3.axisLeft(yScale)
                    .tickValues([0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100])
                    .tickFormat(d => d))
                .select(".domain").remove();

            // Draw main rectangles
            const leftColX = 0;
            const leftColWidth = 180;
            const middleColX = leftColX + leftColWidth;
            const middleColWidth = 180;
            const rightColX = middleColX + middleColWidth + 80;
            const rightColWidth = 180;

            // Scale factors for height calculation
            const heightScale = chartHeight / 100;
            const valueToPercentScale = 100 / maxValue;

            // Left column - Assets
            const totalAssetsPercent = data.total_assets * valueToPercentScale;
            
            // Current assets
            const currentAssetsHeight = (data.current_assets * valueToPercentScale) * heightScale;
            const currentAssetsY = chartHeight - (totalAssetsPercent * heightScale);
            
            g.append("rect")
                .attr("x", leftColX)
                .attr("y", currentAssetsY)
                .attr("width", leftColWidth)
                .attr("height", currentAssetsHeight)
                .attr("fill", palette.assets.current)
                .attr("fill-opacity", 0.2)
                .attr("stroke", palette.assets.current)
                .attr("stroke-width", 1);

            g.append("text")
                .attr("x", leftColX + 10)
                .attr("y", currentAssetsY + 25)
                .attr("class", "rect-label")
                .style("fill", palette.assets.current)
                .text("Current");
            g.append("text")
                .attr("x", leftColX + 10)
                .attr("y", currentAssetsY + 42)
                .attr("class", "rect-label")
                .style("fill", palette.assets.current)
                .text("assets");
            g.append("text")
                .attr("x", leftColX + 10)
                .attr("y", currentAssetsY + 60)
                .attr("class", "rect-value")
                .style("fill", palette.assets.current)
                .text(data.current_assets.toLocaleString());
            g.append("text")
                .attr("x", leftColX + 10)
                .attr("y", currentAssetsY + 78)
                .attr("class", "rect-percentage")
                .style("fill", palette.assets.current)
                .text(`${ratios.current_assets_ratio}%`);

            // Non-current assets
            const nonCurrentAssetsHeight = (data.non_current_assets * valueToPercentScale) * heightScale;
            const nonCurrentAssetsY = currentAssetsY + currentAssetsHeight;
            
            g.append("rect")
                .attr("x", leftColX)
                .attr("y", nonCurrentAssetsY)
                .attr("width", leftColWidth)
                .attr("height", nonCurrentAssetsHeight)
                .attr("fill", palette.assets.non_current)
                .attr("fill-opacity", 0.2)
                .attr("stroke", palette.assets.non_current)
                .attr("stroke-width", 1);

            g.append("text")
                .attr("x", leftColX + 10)
                .attr("y", nonCurrentAssetsY + 25)
                .attr("class", "rect-label")
                .style("fill", palette.assets.non_current)
                .text("Non-current");
            g.append("text")
                .attr("x", leftColX + 10)
                .attr("y", nonCurrentAssetsY + 42)
                .attr("class", "rect-label")
                .style("fill", palette.assets.non_current)
                .text("assets");
            g.append("text")
                .attr("x", leftColX + 10)
                .attr("y", nonCurrentAssetsY + 60)
                .attr("class", "rect-value")
                .style("fill", palette.assets.non_current)
                .text(data.non_current_assets.toLocaleString());
            g.append("text")
                .attr("x", leftColX + 10)
                .attr("y", nonCurrentAssetsY + 78)
                .attr("class", "rect-percentage")
                .style("fill", palette.assets.non_current)
                .text(`${ratios.non_current_assets_ratio}%`);

            // Total assets label
            g.append("text")
                .attr("x", leftColX + leftColWidth/2)
                .attr("y", currentAssetsY - 25)
                .attr("text-anchor", "middle")
                .attr("class", "rect-label")
                .style("fill", palette.assets.total)
                .text("Total assets");
            g.append("text")
                .attr("x", leftColX + leftColWidth/2)
                .attr("y", currentAssetsY - 8)
                .attr("text-anchor", "middle")
                .attr("class", "rect-value")
                .style("fill", palette.assets.total)
                .text(data.total_assets.toLocaleString());

            // Middle column - Liabilities
            // Current liabilities
            const currentLiabilitiesHeight = (data.current_liabilities * valueToPercentScale) * heightScale;
            const currentLiabilitiesY = chartHeight - (totalAssetsPercent * heightScale);
            
            g.append("rect")
                .attr("x", middleColX)
                .attr("y", currentLiabilitiesY)
                .attr("width", middleColWidth)
                .attr("height", currentLiabilitiesHeight)
                .attr("fill", palette.liabilities.current)
                .attr("fill-opacity", 0.2)
                .attr("stroke", palette.liabilities.current)
                .attr("stroke-width", 1);

            g.append("text")
                .attr("x", middleColX + 10)
                .attr("y", currentLiabilitiesY + 25)
                .attr("class", "rect-label")
                .style("fill", palette.liabilities.current)
                .text("Current");
            g.append("text")
                .attr("x", middleColX + 10)
                .attr("y", currentLiabilitiesY + 42)
                .attr("class", "rect-label")
                .style("fill", palette.liabilities.current)
                .text("liabilities");
            g.append("text")
                .attr("x", middleColX + 10)
                .attr("y", currentLiabilitiesY + 60)
                .attr("class", "rect-value")
                .style("fill", palette.liabilities.current)
                .text(data.current_liabilities.toLocaleString());
            g.append("text")
                .attr("x", middleColX + 10)
                .attr("y", currentLiabilitiesY + 78)
                .attr("class", "rect-percentage")
                .style("fill", palette.liabilities.current)
                .text(`${ratios.current_liabilities_ratio}%`);

            // Non-current liabilities
            const nonCurrentLiabilitiesHeight = (data.non_current_liabilities * valueToPercentScale) * heightScale;
            const nonCurrentLiabilitiesY = currentLiabilitiesY + currentLiabilitiesHeight;
            
            g.append("rect")
                .attr("x", middleColX)
                .attr("y", nonCurrentLiabilitiesY)
                .attr("width", middleColWidth)
                .attr("height", nonCurrentLiabilitiesHeight)
                .attr("fill", palette.liabilities.non_current)
                .attr("fill-opacity", 0.2)
                .attr("stroke", palette.liabilities.non_current)
                .attr("stroke-width", 1);

            g.append("text")
                .attr("x", middleColX + 10)
                .attr("y", nonCurrentLiabilitiesY + 25)
                .attr("class", "rect-label")
                .style("fill", palette.liabilities.non_current)
                .text("Non-current");
            g.append("text")
                .attr("x", middleColX + 10)
                .attr("y", nonCurrentLiabilitiesY + 42)
                .attr("class", "rect-label")
                .style("fill", palette.liabilities.non_current)
                .text("liabilities");
            g.append("text")
                .attr("x", middleColX + 10)
                .attr("y", nonCurrentLiabilitiesY + 60)
                .attr("class", "rect-value")
                .style("fill", palette.liabilities.non_current)
                .text(data.non_current_liabilities.toLocaleString());
            g.append("text")
                .attr("x", middleColX + 10)
                .attr("y", nonCurrentLiabilitiesY + 78)
                .attr("class", "rect-percentage")
                .style("fill", palette.liabilities.non_current)
                .text(`${ratios.non_current_liabilities_ratio}%`);

            // Interest bearing liabilities (dashed box)
            // Top: current interest-bearing portion above the top of Non-current liabilities
            // Bottom: non-current interest-bearing portion below the top of Non-current liabilities
            const currentInterestBearingHeight = (data.current_interest_bearing_liabilities * valueToPercentScale) * heightScale;
            const nonCurrentInterestBearingHeight = (data.non_current_interest_bearing_liabilities * valueToPercentScale) * heightScale;
            const interestBearingY = nonCurrentLiabilitiesY - currentInterestBearingHeight;
            const interestBearingHeight = currentInterestBearingHeight + nonCurrentInterestBearingHeight;
            
            g.append("rect")
                .attr("x", middleColX + middleColWidth / 2)
                .attr("y", interestBearingY)
                .attr("width", middleColWidth / 2)
                .attr("height", interestBearingHeight)
                .attr("class", "dashed-rect");
            // Override dashed-rect CSS to apply a translucent fill
            g.select(".dashed-rect")
                .style("fill", palette.liabilities.interest_total)
                .style("fill-opacity", 0.2);

            g.append("text")
                .attr("x", middleColX + middleColWidth / 2 + 5)
                .attr("y", interestBearingY + 20)
                .attr("class", "rect-label")
                .style("font-size", "12px")
                .style("fill", palette.liabilities.interest_total)
                .text("Interest");
            g.append("text")
                .attr("x", middleColX + middleColWidth / 2 + 5)
                .attr("y", interestBearingY + 35)
                .attr("class", "rect-label")
                .style("font-size", "12px")
                .style("fill", palette.liabilities.interest_total)
                .text("bearing");
            g.append("text")
                .attr("x", middleColX + middleColWidth / 2 + 5)
                .attr("y", interestBearingY + 50)
                .attr("class", "rect-label")
                .style("font-size", "12px")
                .style("fill", palette.liabilities.interest_total)
                .text("liabilities");
            g.append("text")
                .attr("x", middleColX + middleColWidth / 2 + 5)
                .attr("y", interestBearingY + 68)
                .attr("class", "rect-value")
                .style("font-size", "12px")
                .style("fill", palette.liabilities.interest_total)
                .text(`${data.interest_bearing_liabilities.toLocaleString()}`);
            g.append("text")
                .attr("x", middleColX + middleColWidth / 2 + 5)
                .attr("y", interestBearingY + 83)
                .attr("class", "rect-value")
                .style("font-size", "12px")
                .style("fill", palette.liabilities.interest_total)
                .text(`${ratios.interest_bearing_liabilities_ratio}%`);

            // Stockholders' equity
            const netAssetsHeight = (data.net_assets * valueToPercentScale) * heightScale;
            const netAssetsY = nonCurrentLiabilitiesY + nonCurrentLiabilitiesHeight;
            
            g.append("rect")
                .attr("x", middleColX)
                .attr("y", netAssetsY)
                .attr("width", middleColWidth)
                .attr("height", netAssetsHeight)
                .attr("fill", palette.equity.net_assets)
                .attr("fill-opacity", 0.2)
                .attr("stroke", palette.equity.net_assets)
                .attr("stroke-width", 1);

            g.append("text")
                .attr("x", middleColX + 10)
                .attr("y", netAssetsY + 25)
                .attr("class", "rect-label")
                .style("fill", palette.equity.net_assets)
                .text("Stockholders'");
            g.append("text")
                .attr("x", middleColX + 10)
                .attr("y", netAssetsY + 42)
                .attr("class", "rect-label")
                .style("fill", palette.equity.net_assets)
                .text("equity");
            g.append("text")
                .attr("x", middleColX + 10)
                .attr("y", netAssetsY + 60)
                .attr("class", "rect-value")
                .style("fill", palette.equity.net_assets)
                .text(data.net_assets.toLocaleString());
            g.append("text")
                .attr("x", middleColX + 10)
                .attr("y", netAssetsY + 78)
                .attr("class", "rect-percentage")
                .style("fill", palette.equity.net_assets)
                .text(`${ratios.net_assets_ratio}%`);

            // Retained earnings as a right-aligned rectangle (1/3 width)
            const retainedEarningsHeight = (data.retained_earnings * valueToPercentScale) * heightScale;
            const retainedEarningsY = chartHeight - retainedEarningsHeight;
            const retainedEarningsX = middleColX + 1 * (middleColWidth / 3);
            const retainedEarningsWidth = 2 * (middleColWidth / 3);

            g.append("rect")
                .attr("x", retainedEarningsX)
                .attr("y", retainedEarningsY)
                .attr("width", retainedEarningsWidth)
                .attr("height", retainedEarningsHeight)
                .attr("fill", palette.equity.retained_earnings)
                .attr("fill-opacity", 0.2)
                .attr("stroke", palette.equity.retained_earnings)
                .attr("stroke-width", 1);

            g.append("text")
                .attr("x", retainedEarningsX + 10)
                .attr("y", retainedEarningsY + 25)
                .attr("class", "rect-label")
                .style("fill", palette.equity.retained_earnings)
                .text("Retained");
            g.append("text")
                .attr("x", retainedEarningsX + 10)
                .attr("y", retainedEarningsY + 42)
                .attr("class", "rect-label")
                .style("fill", palette.equity.retained_earnings)
                .text("earnings");
            g.append("text")
                .attr("x", retainedEarningsX + 10)
                .attr("y", retainedEarningsY + 60)
                .attr("class", "rect-value")
                .style("fill", palette.equity.retained_earnings)
                .text(`${data.retained_earnings.toLocaleString()} ${ratios.retained_earnings_ratio}%`);

            // Right column - Income Statement
            const netSalesPercent = data.net_sales * valueToPercentScale;
            const rightColHeight = netSalesPercent * heightScale;
            const rightColY = chartHeight - rightColHeight;
            
            // Main rectangle for income statement
            g.append("rect")
                .attr("x", rightColX)
                .attr("y", rightColY)
                .attr("width", rightColWidth)
                .attr("height", rightColHeight)
                .attr("fill", palette.income.net_sales)
                .attr("fill-opacity", 0.05)
                .attr("stroke", palette.income.net_sales)
                .attr("stroke-width", 1);

            // Zero baseline for right column values is the bottom of the Net sales frame
            const yZero = rightColY + rightColHeight;

            // Split Net sales into Cost of sales (top) and Gross profit (bottom)
            // Render only if Gross Profit is provided and > 0
            if (data.gross_profit > 0) {
                const grossProfitHeight = data.net_sales > 0 ? (data.gross_profit / data.net_sales) * rightColHeight : 0;
                const costOfSalesValue = Math.max(0, data.net_sales - data.gross_profit);
                const costOfSalesHeight = data.net_sales > 0 ? (costOfSalesValue / data.net_sales) * rightColHeight : 0;

                // Cost of sales rectangle (top)
                const costOfSalesY = rightColY;
                g.append("rect")
                    .attr("x", rightColX)
                    .attr("y", costOfSalesY)
                    .attr("width", rightColWidth)
                    .attr("height", costOfSalesHeight)
                    .attr("fill", palette.income.cost_of_sales)
                    .attr("fill-opacity", 0.2)
                    .attr("stroke", palette.income.cost_of_sales)
                    .attr("stroke-width", 1);

                // Cost of sales labels and values (top section)
                g.append("text")
                    .attr("x", rightColX + 10)
                    .attr("y", rightColY + 25)
                    .attr("text-anchor", "start")
                    .attr("class", "rect-label")
                    .style("fill", palette.income.cost_of_sales)
                    .text("Cost of");
                g.append("text")
                    .attr("x", rightColX + 10)
                    .attr("y", rightColY + 42)
                    .attr("text-anchor", "start")
                    .attr("class", "rect-label")
                    .style("fill", palette.income.cost_of_sales)
                    .text("sales");
                g.append("text")
                    .attr("x", rightColX + 10)
                    .attr("y", rightColY + 60)
                    .attr("text-anchor", "start")
                    .attr("class", "rect-value")
                    .style("fill", palette.income.cost_of_sales)
                    .text(costOfSalesValue.toLocaleString());
                g.append("text")
                    .attr("x", rightColX + 10)
                    .attr("y", rightColY + 78)
                    .attr("text-anchor", "start")
                    .attr("class", "rect-percentage")
                    .style("fill", palette.income.cost_of_sales)
                    .text(`${(data.net_sales > 0 ? (costOfSalesValue / data.net_sales * 100).toFixed(1) : '0.0')}%`);

                // Gross profit rectangle (bottom)
                const gpY = rightColY + costOfSalesHeight;
                g.append("rect")
                    .attr("x", rightColX)
                    .attr("y", gpY)
                    .attr("width", rightColWidth)
                    .attr("height", grossProfitHeight)
                    .attr("fill", palette.income.gross_profit)
                    .attr("fill-opacity", 0.2)
                    .attr("stroke", palette.income.gross_profit)
                    .attr("stroke-width", 1);

                // Gross profit labels and values (bottom section)
                g.append("text")
                    .attr("x", rightColX + 10)
                    .attr("y", gpY + 25)
                    .attr("text-anchor", "start")
                    .attr("class", "rect-label")
                    .style("fill", palette.income.gross_profit)
                    .text("Gross");
                g.append("text")
                    .attr("x", rightColX + 10)
                    .attr("y", gpY + 42)
                    .attr("text-anchor", "start")
                    .attr("class", "rect-label")
                    .style("fill", palette.income.gross_profit)
                    .text("profit");
                g.append("text")
                    .attr("x", rightColX + 10)
                    .attr("y", gpY + 60)
                    .attr("text-anchor", "start")
                    .attr("class", "rect-value")
                    .style("fill", palette.income.gross_profit)
                    .text(data.gross_profit.toLocaleString());
                g.append("text")
                    .attr("x", rightColX + 10)
                    .attr("y", gpY + 78)
                    .attr("text-anchor", "start")
                    .attr("class", "rect-percentage")
                    .style("fill", palette.income.gross_profit)
                    .text(`${(data.net_sales > 0 ? (data.gross_profit / data.net_sales * 100).toFixed(1) : '0.0')}%`);
            } else if (data.gross_profit < 0) {
                // Draw negative Gross profit extending below the zero baseline
                const gpNegHeight = data.net_sales > 0 ? (Math.abs(data.gross_profit) / data.net_sales) * rightColHeight : 0;
                const gpNegY = yZero;

                g.append("rect")
                    .attr("x", rightColX)
                    .attr("y", gpNegY)
                    .attr("width", rightColWidth)
                    .attr("height", gpNegHeight)
                    .attr("fill", palette.income.gross_profit)
                    .attr("fill-opacity", 0.2)
                    .attr("stroke", palette.income.gross_profit)
                    .attr("stroke-width", 1);

                // Negative Gross profit labels
                g.append("text")
                    .attr("x", rightColX + 10)
                    .attr("y", gpNegY + 25)
                    .attr("text-anchor", "start")
                    .attr("class", "rect-label")
                    .style("fill", palette.income.gross_profit)
                    .text("Gross");
                g.append("text")
                    .attr("x", rightColX + 10)
                    .attr("y", gpNegY + 42)
                    .attr("text-anchor", "start")
                    .attr("class", "rect-label")
                    .style("fill", palette.income.gross_profit)
                    .text("profit");
                g.append("text")
                    .attr("x", rightColX + 10)
                    .attr("y", gpNegY + 60)
                    .attr("text-anchor", "start")
                    .attr("class", "rect-value")
                    .style("fill", palette.income.gross_profit)
                    .text(data.gross_profit.toLocaleString());
                g.append("text")
                    .attr("x", rightColX + 10)
                    .attr("y", gpNegY + 78)
                    .attr("text-anchor", "start")
                    .attr("class", "rect-percentage")
                    .style("fill", palette.income.gross_profit)
                    .text(`${(data.net_sales > 0 ? (data.gross_profit / data.net_sales * 100).toFixed(1) : '0.0')}%`);
            }
           
            // Operating income section as a rectangle aligned to the right 2/3 of the column
            const operatingIncomeHeight = data.net_sales > 0 ? (Math.abs(data.operating_income) / data.net_sales) * rightColHeight : 0;
            const operatingIncomeTopY = data.operating_income >= 0
                ? (yZero - operatingIncomeHeight)
                : yZero;
            const oiX = rightColX + (rightColWidth / 3);
            const oiW = rightColWidth * (2/3);

            g.append("rect")
                .attr("x", oiX)
                .attr("y", operatingIncomeTopY)
                .attr("width", oiW)
                .attr("height", operatingIncomeHeight)
                .attr("fill", palette.income.operating_income)
                .attr("fill-opacity", 0.2)
                .attr("stroke", palette.income.operating_income)
                .attr("stroke-width", 1);

            g.append("text")
                .attr("x", oiX + 10)
                .attr("y", operatingIncomeTopY + 25)
                .attr("text-anchor", "start")
                .attr("class", "rect-label")
                .style("fill", palette.income.operating_income)
                .text("Operating");
            g.append("text")
                .attr("x", oiX + 10)
                .attr("y", operatingIncomeTopY + 42)
                .attr("text-anchor", "start")
                .attr("class", "rect-label")
                .style("fill", palette.income.operating_income)
                .text("income");
            g.append("text")
                .attr("x", oiX + 10)
                .attr("y", operatingIncomeTopY + 60)
                .attr("text-anchor", "start")
                .attr("class", "rect-value")
                .style("fill", palette.income.operating_income)
                .text(data.operating_income.toLocaleString());
            g.append("text")
                .attr("x", oiX + 10)
                .attr("y", operatingIncomeTopY + 78)
                .attr("text-anchor", "start")
                .attr("class", "rect-percentage")
                .style("fill", palette.income.operating_income)
                .text(`${ratios.operating_income_ratio}%`);

            // Net income section as a right-aligned rectangle (1/3 width)
            const netIncomeHeight = data.net_sales > 0 ? (Math.abs(data.net_income) / data.net_sales) * rightColHeight : 0;
            const niW = rightColWidth / 3;
            const niX = rightColX + rightColWidth - niW; // right aligned
            const netIncomeTopY = data.net_income >= 0
                ? (yZero - netIncomeHeight)
                : yZero;

            g.append("rect")
                .attr("x", niX)
                .attr("y", netIncomeTopY)
                .attr("width", niW)
                .attr("height", netIncomeHeight)
                .attr("fill", palette.income.net_income)
                .attr("fill-opacity", 0.2)
                .attr("stroke", palette.income.net_income)
                .attr("stroke-width", 1);

            g.append("text")
                .attr("x", niX + 10)
                .attr("y", netIncomeTopY + 25)
                .attr("text-anchor", "start")
                .attr("class", "net-income-label")
                .style("fill", palette.income.net_income)
                .text("Net income");
            g.append("text")
                .attr("x", niX + 10)
                .attr("y", netIncomeTopY + 42)
                .attr("text-anchor", "start")
                .attr("class", "rect-value")
                .style("fill", palette.income.net_income)
                .text(`${data.net_income.toLocaleString()} ${ratios.net_income_ratio}%`);

            // Net sales label
            g.append("text")
                .attr("x", rightColX + 10)
                .attr("y", rightColY - 25)
                .attr("text-anchor", "start")
                .attr("class", "net-sales-label")
                .style("fill", palette.income.net_sales)
                .text("Net sales");
            g.append("text")
                .attr("x", rightColX + 10)
                .attr("y", rightColY - 8)
                .attr("text-anchor", "start")
                .attr("class", "rect-value")
                .style("fill", palette.income.net_sales)
                .text(data.net_sales.toLocaleString());

            // Connecting line from Total assets to Net sales
            // Both should be at their respective top positions (scaled to chart)
            const totalAssetsTopY = currentAssetsY;  // Top of Total assets bar
            const netSalesTopY = rightColY;  // Top of Net sales bar
            
            const connectionPath = `M ${middleColX + middleColWidth} ${totalAssetsTopY} 
                                   L ${rightColX} ${netSalesTopY}`;
            g.append("path")
                .attr("d", connectionPath)
                .attr("stroke", palette.neutral.connection)
                .attr("stroke-width", 1)
                //.attr("stroke-dasharray", "5,3")
                .attr("fill", "none");

            // Caption at bottom
            g.append("text")
                .attr("x", chartWidth / 2)
                .attr("y", chartHeight + 115)
                .attr("text-anchor", "middle")
                .style("font-size", "18px")
                .style("font-weight", "bold")
                .text("Sheet and Income Statement Numbers");
        }

        // Function to update chart
        function updateChart() {
            const data = getInputData();
            drawChart(data);
        }

        // Serialize the current SVG and download as a standalone .svg file
        function saveChartAsSVG() {
            const svg = document.querySelector('#chart svg');
            if (!svg) {
                alert('No chart to save. Please generate the chart first.');
                return;
            }

            // Clone to avoid mutating on-page SVG
            const clone = svg.cloneNode(true);
            // Ensure namespaces
            clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
            clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
            // Ensure viewBox present for portability
            const w = parseFloat(clone.getAttribute('width')) || svg.clientWidth || 800;
            const h = parseFloat(clone.getAttribute('height')) || svg.clientHeight || 600;
            if (!clone.getAttribute('viewBox')) {
                clone.setAttribute('viewBox', `0 0 ${w} ${h}`);
            }

            // Inline computed styles so the SVG is self-contained
            const PRESENTATION_PROPS = [
                'fill','fill-opacity','stroke','stroke-width','stroke-opacity','stroke-dasharray','stroke-linecap','stroke-linejoin','opacity',
                'font-family','font-size','font-weight','font-style','text-anchor','shape-rendering'
            ];
            const ATTR_MAP = ['text-anchor']; // some props also work better as attributes

            function inlineStyles(el) {
                if (el.nodeType !== 1) return; // element only
                const cs = window.getComputedStyle(el);
                let styleStr = el.getAttribute('style') || '';
                PRESENTATION_PROPS.forEach(prop => {
                    const val = cs.getPropertyValue(prop);
                    if (val && val !== 'normal' && val !== 'none' && val.trim() !== '') {
                        styleStr += `${prop}:${val};`;
                    }
                });
                if (styleStr) el.setAttribute('style', styleStr);

                // Also set a few presentation attributes explicitly
                ATTR_MAP.forEach(attr => {
                    const val = cs.getPropertyValue(attr);
                    if (val && val.trim() !== '') el.setAttribute(attr, val);
                });

                Array.from(el.children).forEach(inlineStyles);
            }
            // Append clone off-screen so getComputedStyle works reliably
            const tmpWrapper = document.createElement('div');
            tmpWrapper.style.position = 'fixed';
            tmpWrapper.style.left = '-10000px';
            tmpWrapper.style.top = '-10000px';
            tmpWrapper.style.visibility = 'hidden';
            tmpWrapper.appendChild(clone);
            document.body.appendChild(tmpWrapper);

            inlineStyles(clone);

            // Optional: embed a white background rect if none exists
            if (!clone.querySelector('rect.__export_bg__')) {
                const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                bg.setAttribute('class', '__export_bg__');
                bg.setAttribute('x', '0');
                bg.setAttribute('y', '0');
                bg.setAttribute('width', w);
                bg.setAttribute('height', h);
                bg.setAttribute('fill', 'white');
                clone.insertBefore(bg, clone.firstChild);
            }

            const serializer = new XMLSerializer();
            let source = serializer.serializeToString(clone);
            // Add XML declaration for better compatibility
            if (!source.match(/^<\?xml/)) {
                source = `<?xml version="1.0" encoding="UTF-8"?>\n` + source;
            }

            const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const data = getInputData();
            const company = (data.company_name || 'chart').replace(/[^\w\-]+/g, '_');
            const period = (data.period_label || '').toString().replace(/[^\w\-]+/g, '_');
            const filename = `${company}${period ? '_' + period : ''}.svg`;

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            // Clean up temporary DOM
            document.body.removeChild(tmpWrapper);
            URL.revokeObjectURL(url);
        }

        // Auto-calculate Total Assets
        function calculateTotalAssets() {
            const currentAssets = parseFloat(document.getElementById('currentAssets').value) || 0;
            const nonCurrentAssets = parseFloat(document.getElementById('nonCurrentAssets').value) || 0;
            document.getElementById('totalAssets').value = currentAssets + nonCurrentAssets;
        }

        // Auto-calculate Interest-bearing Liabilities
        function calculateInterestBearingLiabilities() {
            const currentInterestBearingLiabilities = parseFloat(document.getElementById('currentInterestBearingLiabilities').value) || 0;
            const nonCurrentInterestBearingLiabilities = parseFloat(document.getElementById('nonCurrentInterestBearingLiabilities').value) || 0;
            document.getElementById('interestBearingLiabilities').value = currentInterestBearingLiabilities + nonCurrentInterestBearingLiabilities;
        }

        // Wait for DOM to be fully loaded
        window.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for auto-calculation
            document.getElementById('currentAssets').addEventListener('input', calculateTotalAssets);
            document.getElementById('nonCurrentAssets').addEventListener('input', calculateTotalAssets);
            document.getElementById('currentInterestBearingLiabilities').addEventListener('input', calculateInterestBearingLiabilities);
            document.getElementById('nonCurrentInterestBearingLiabilities').addEventListener('input', calculateInterestBearingLiabilities);

            // Add event listener for update button
            document.getElementById('updateButton').addEventListener('click', updateChart);
            // Add event listener for save button
            document.getElementById('saveSvgButton').addEventListener('click', saveChartAsSVG);
            
            // Initial chart draw
            updateChart();
        });
    </script>
</body>
</html>